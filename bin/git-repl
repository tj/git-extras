#!/usr/bin/env bash

git version
echo "git-extras version ""$(git-extras -v)"
echo "type 'ls' to ls files below current directory, '!command' to execute any command or just 'subcommand' to execute any git subcommand. 'quit', 'exit', 'q', 'x', ^D, or ^C to exit the git repl."

while true; do
  # Current branch
  cur=$(git symbolic-ref HEAD 2> /dev/null | cut -d/ -f3-)

  # Prompt
  if test -n "$cur"; then
    prompt="$exit_status|git ($cur)> "
  else
    prompt="$exit_status|git> "
  fi

  # Use arguments as a command if any are provided
  if [ $# -ne 0 ]; then
    cmd="$@"
    set --
  else
    # Readline
    read -e -r -p "$prompt" cmd
    # check for EOF, and end the program if so (handles ^D)
    test $? -ne 0 && break
  fi

  # History
  history -s "$cmd"

  # Built-in commands
  case $cmd in
    ls) cmd=ls-files;;
    "") continue;;
    quit|exit|q|x) break;;
  esac

  if [[ $cmd == !*  ]]; then
    eval ${cmd:1}
    exit_status=$?
  elif [[ $cmd == git* ]]; then
    eval $cmd
    exit_status=$?
  else
    eval git "$cmd"
    exit_status=$?
  fi
done

echo
